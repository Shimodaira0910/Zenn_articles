---
title: "Terraformã§ã‚ˆãè¦‹ã‚‹æ‹¡å¼µå­"
emoji: "ğŸ¤–"
type: "tech"
topics:
  - "aws"
  - "terraform"
published: true
published_at: "2023-10-06 16:19"
---

## ã¯ã˜ã‚ã«
æœ€è¿‘Terraformã‚’å­¦ã³å§‹ã‚ã¾ã—ãŸãŒã€æ‹¡å¼µå­ã€Œ.tfã€ä»¥å¤–ã«ã€Œ.tfstateã€ã¨ã‹ã€Œ.tfvarsã€ã ã£ãŸã‚Š
ã¯ãŸã¾ãŸ.tfã®é¢å½±ã‚‚ãªã„ã€Œ.terraform.lock.hclã€ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã°ã‹ã‚Šã§å›°æƒ‘ã—ã¦ã„ã‚‹ã®ã§ã€ä»Šå›ã¯Terraformã§ã‚ˆãè¦‹ã‚‹æ‹¡å¼µå­ã¨ã€ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã«ã¤ã„ã¦æ•´ç†ã—ã¦ã¿ã¾ã—ãŸã€‚

# å‹•ä½œç’°å¢ƒ
| ä½¿ã£ãŸã‚‚ã® | ãƒãƒ¼ã‚¸ãƒ§ãƒ³ |
| --- |  --- |
| macOS | Ventura 13.5.2 |
| Terraform | 1.5.7 |

# ã“ã®è¨˜äº‹ã§æ›¸ã‹ãªã„ã“ã¨
ãƒ»Terraformã®ã‚³ãƒãƒ³ãƒ‰ã€æ§‹æˆæƒ…å ±ã‚„ãƒªã‚½ãƒ¼ã‚¹å®šç¾©ã€å¤‰æ•°å®šç¾©ã®å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰ã®æ›¸ãæ–¹
ãƒ»AWSãƒªã‚½ãƒ¼ã‚¹ã®è©±

# Terraformã¨ã¯?
Terraformã¨ã¯ã€ã‚¤ãƒ³ãƒ•ãƒ©ç’°å¢ƒã‚’HCLã¨ã„ã†ç‹¬è‡ªã®è¨˜è¿°è¨€èªã§ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã—ã€è‡ªå‹•åŒ–ã™ã‚‹ãŸã‚ã®ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã®IaC(Infrastructure as Code)ãƒ„ãƒ¼ãƒ«ã®ä¸€ã¤ã§ã™ã€‚HashiCorpç¤¾ã«ã‚ˆã£ã¦ã€Goè¨€èªã§é–‹ç™ºã•ã‚ŒãŸãã†ãªã€‚

HCLã¨ã„ã†è¨€èªã‚’ç”¨ã„ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆAWSã€Azureã€Google Cloudãªã©ï¼‰ã‚„ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç’°å¢ƒãªã©ã®ã‚¤ãƒ³ãƒ•ãƒ©ç’°å¢ƒã‚’å®šç¾©ã—ã€ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã€å¤‰æ›´ã€å‰Šé™¤ã‚’ç°¡å˜ã‹ã¤å†ç¾å¯èƒ½ãªæ–¹æ³•ã§è¡Œã†ã“ã¨ãŒã§ãã¦ã—ã¾ã„ã¾ã™ã€‚ã‚¹ã‚´ã‚¤ã€‚

https://www.terraform.io/
https://www.lac.co.jp/lacwatch/service/20200903_002270.html

# .tf
Terraformã§ã‚¤ãƒ³ãƒ•ãƒ©ç’°å¢ƒã‚’è¨˜è¿°ã™ã‚‹éš›ã€HCLã¨ã„ã†è¨€èªã§æ›¸ãã¨ã„ã†ã®ã¯å…ˆã»ã©è©±ã—ã¾ã—ãŸãŒã€HCLã‚’è¨˜è¿°ã™ã‚‹éš›ã®æ¨™æº–çš„ãªæ‹¡å¼µå­ãŒã€Œ.tfã€ã«ãªã‚Šã¾ã™ã€‚
ã“ã®tfã§å®šç¾©ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¤ãƒ³ãƒ•ãƒ©ç’°å¢ƒã‚’å®šç¾©ã—ã¦ã„ãæµã‚Œã«ãªã‚Šã¾ã™ã€‚

ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯ã€æ‹¡å¼µå­.tfãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãæ–¹ã®ä¾‹ã«ãªã‚Šã¾ã™ã€‚

```tf:main.tf
provider "aws" {
  profile = "xxxxxxx"
  region  = "ap-northeast-1"
}

resource "aws_vpc" "vpc" {
  cidr_block                       = "192.168.0.0/20"
  instance_tenancy                 = "default"
  enable_dns_support               = true
  enable_dns_hostnames             = true
  assign_generated_ipv6_cidr_block = false
}
```

ã“ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã€åˆ©ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒ‘ã‚¤ãƒ€ãƒ¼ã‚’AWSã«æŒ‡å®šã—ã€TerraformãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆ(profile)ã¨ã€TerraformãŒAWSãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€VPCãŒæŒ‡å®šã•ã‚ŒãŸãƒªãƒ¼ã‚¸ãƒ§ãƒ³å†…ã§ä½œæˆã•ã‚Œã¾ã™ã€‚

# .tfstate
Terraformã‚’ä½¿ã£ã¦æ§‹ç¯‰ã—ãŸã‚¯ãƒ©ã‚¦ãƒ‰ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’è¡¨ã™ãƒ•ã‚¡ã‚¤ãƒ«ãŒã€Œ.tfstateã€æ‹¡å¼µå­ã«ãªã‚Šã¾ã™ã€‚

TerraformãŒãƒªã‚½ãƒ¼ã‚¹ã®å¤‰æ›´ç­‰ã‚’è¡Œã†ã¨ãã«ã€å‰å›æ›´æ–°å†…å®¹ãŒæ›¸ã‹ã‚ŒãŸã€Œ.tfstateã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã€æ¬¡å›æ›´æ–°æ™‚ã«ä½•ã‚‰ã‹ã®å¤‰æ›´ãŒã‚ã‚Œã°ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤ã‚’è¡Œã„ã€æ–°ã—ã„çŠ¶æ…‹ã‚’ã€Œ.tfstateã€ãƒ•ã‚¡ã‚¤ãƒ«ã«åæ˜ ã—ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/3dce09d02a6a-20231005.png)
è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§Terraformã®ã‚³ãƒ¼ãƒ‰ã‚’ç®¡ç†ã™ã‚‹å ´åˆã€å„ã€…ãŒTerraformã§ãƒªã‚½ãƒ¼ã‚¹ã®æ›´æ–°ã‚’è¡Œã£ã¦ã—ã¾ã†ã¨å„ãƒ¦ãƒ¼ã‚¶ãƒ¼åŒå£«ã§tfstateã®æ•´åˆæ€§ãŒå–ã‚Œãªããªã£ã¦ã—ã¾ã†ãŸã‚ã€ç«¶åˆç¥­ã‚ŠãŒå§‹ã¾ã‚Šã¾ã™ã€‚
æœ€æ‚ªã®å ´åˆã‚¤ãƒ³ãƒ•ãƒ©ã«æ·±åˆ»ãªå½±éŸ¿ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€åŸºæœ¬çš„ã«ã¯ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰(AWSã§ã‚ã‚Œã°S3)ãªã©ã§ç®¡ç†ã™ã‚‹ã“ã¨ãŒä¸€èˆ¬çš„ã§ã™ã€‚

# .tfvars
ã€Œ.tfvarsã€æ‹¡å¼µå­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€å¤–éƒ¨ã‹ã‚‰èª­ã¿å‡ºã™å¤‰æ•°ã®å€¤ã‚’æ ¼ç´ã—ã¦ãŠããƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚Šã¾ã™ã€‚
ã“ã¡ã‚‰ã§å®šç¾©ã—ãŸå€¤ã¯ã€Terraformã®ã‚³ãƒ¼ãƒ‰å†…ã§`var.{å¤‰æ•°å}`ã¨ã—ã¦å‘¼ã³å‡ºã™ã“ã¨ãŒã§ãã¾ã™ã€‚
ä¾‹ãˆã°ã€å…ˆã»ã©ã®main.tfå†…ã®`cidr_block`ã®å€¤ã€Œ"192.168.0.0/20"ã€ã‚’å¤‰æ•°åŒ–ã—ãŸã„ã¨ã—ã¾ã™ã€‚

```tf:variables.tf
variable "cidr_block" {
    type = string
}
```
ã¾ãšå¤‰æ•°ã‚’ã‚³ãƒ¼ãƒ‰å†…ã§å®£è¨€ã—ã¾ã™ã€‚ä»Šå›ã¯ä¾¿å®œä¸Švariables.tfã¨ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã„ã¾ã™ãŒã€å…ˆã»ã©ã®main.tfå†…ã§ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
```tf:terraform.tfvars
cidr_block="192.168.0.0/20"
```
variables.tfã§å®£è¨€ã—ãŸå¤‰æ•°ã«å€¤ã‚’ä»£å…¥ã™ã‚‹ã®ãŒã€ã“ã®ã€Œ.tfvarsã€ãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚Šã¾ã™ã€‚
```tf:main.tf
provider "aws" {
  profile = "xxxxxxx"
  region  = "ap-northeast-1"
}

resource "aws_vpc" "vpc" {
                                    # å¤‰æ›´ç®‡æ‰€
  cidr_block                       = var.cidr_block
  instance_tenancy                 = "default"
  enable_dns_support               = true
  enable_dns_hostnames             = true
  assign_generated_ipv6_cidr_block = false
}
```
ã“ã†ã™ã‚‹ã“ã¨ã§ã€å¤‰æ•°ã‚’å®£è¨€ãƒ»å€¤ã®ä»£å…¥ã‚’è¡Œã„ã€.tfãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚

.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€é–‹ç™ºãƒ»ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ»æœ¬ç•ªãªã©ã®å„ç’°å¢ƒå›ºæœ‰ã®è¦ç´ (IPã‚¢ãƒ‰ãƒ¬ã‚¹ãªã©)ã‚’ã€å„ç’°å¢ƒç”¨ã®.tfvarsãƒ•ã‚¡ã‚¤ãƒ«ã«å®šç¾©ã—ã¦ã‚ã’ã‚‹ã“ã¨ã§ã€.tfãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã›ãšã«å†åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ç‚¹ãŒæŒ™ã’ã‚‰ã‚Œã¾ã™ã€‚

ã¾ãŸã€ã‚³ãƒ¼ãƒ‰ã«ç›´ã«æ›¸ããŸããªã„ç§˜åŒ¿æƒ…å ±(APIã‚­ãƒ¼ã‚„è¨¼æ˜æ›¸ãªã©ï¼‰ã‚‚ã“ã®.tfvarsãƒ•ã‚¡ã‚¤ãƒ«å†…ã§ç®¡ç†ã—ã¦ã€.tfãƒ•ã‚¡ã‚¤ãƒ«å†…ã«ãƒ™ã‚¿æ›¸ãã™ã‚‹ã“ã¨ã‚’é˜²ãã£ã¦ã“ã¨ã‚‚ã§ãã¾ã™ã€‚å®‰å¿ƒã€‚

```tf:variables.tf
variable "aws_access_key" {
    type = string
}

variable "aws_secret_key" {
    type = string
}
```

```tf:terraform.tfvars
aws_access_key="xxxxxxxxxxxxxxxxxxxxxxxx"
aws_secret_key="yyyyyyyyyyyyyyyyyyyyyyyy"
```

```tf:main.tf
provider "aws" {
  access_key = ${var.aws_access_key}
  secret_key = ${var.secret_key}
  region = "ap-northeast-1"
}
```

# .terraform.lock.hcl
`terraform init`ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã«ç”Ÿæˆã•ã‚Œã‚‹ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«(.tfãƒ•ã‚¡ã‚¤ãƒ«ã«è¨˜è¿°ã—ãŸã‚³ãƒ¼ãƒ‰)ã®ä¾å­˜é–¢ä¿‚ã€äº’æ›æ€§ãŒè¨˜è¼‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ã„ã‚ã‚†ã‚‹ä¾å­˜ãƒ­ãƒƒã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«ãªã‚Šã¾ã™ã€‚

ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã¯å…ˆã»ã©ã®main.tfã‚’ä½œæˆã—ã€`terraform init`ã‚’ã—ãŸéš›ã«ä½œæˆã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚ä¸€è¦‹ä½•ãŒä½•ã ã‹ãªã‚“ã‹ã‚ˆãã‚ã‹ã‚“ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã«è¦‹ãˆã¾ã™ã€‚

```:.terraform.lock.hcl
# This file is maintained automatically by "terraform init".
# Manual edits may be lost in future updates.

provider "registry.terraform.io/hashicorp/aws" {
  version = "5.19.0"
  hashes = [
    "h1:MJclj56jijp7T4V4g5tzHXS3M8vUdJAcBRjEstBh0Hc=",
    "zh:03aa0f857c6dfce5f46c9bf3aad45534b9421e68983994b6f9dd9812beaece9c",
    "zh:0639818c5bf9f9943667f39ec38bb945c9786983025dff407390133fa1ca5041",
    "zh:0b82ad42ced8fb4a138eaf2fd37cf6059ca0bb482114b35fb84f22fc1500324a",
    "zh:173e8c19a9f1d8f6457c80f4a73a92f420a81d650fc4ad0f97a5dc4b9485bba8",
    "zh:42913a40ddfe9b4f3c78ad2e3cdc1dcfd48151bc132dc6b49fc32cd6da79db21",
    "zh:452db5caca2e53d5f7090979d518e77aa5fd98385514b11ee2ce76a46e89cb53",
    "zh:9b12af85486a96aedd8d7984b0ff811a4b42e3d88dad1a3fb4c0b580d04fa425",
    "zh:a12377ade89ee18d9be116436e411e8396898bd70b21ab027c161c785e86238d",
    "zh:aa9e4746ba49044ad5b4dda57fcdba7bc16fe65f696766fb2c55c30a27abf844",
    "zh:adfaee76d283f1c321fad2e4154be88d57da8c2ecfdca9516c8920bd2ece36ed",
    "zh:bf6fbc6d60661c03ed2214173c1deced908dc62480dd41e67ac399fa4abd7467",
    "zh:cb685da03ad00d1a27891f3d366d75e8795ac81f1b427888b434e6832ca40633",
    "zh:e0432c78dfaf2baebe2bf5c0ad8087f547c69c2c5a00e4c1dcd5a6344ce726df",
    "zh:e0ec9ccb8d34d6d0d8bf7f8628c223951832b4d50ea8887fc711fa854b3a28b4",
    "zh:f274397ada4ef3c1dce2f70e719c8ccf19fc4e7a2e3f45d018764c6267fd7157",
  ]
}
```
ã‚³ãƒ¼ãƒ‰ã®æ„å‘³ã‚’ç°¡å˜ã«è¨˜è¼‰ã™ã‚‹ã¨
- provider "registry.terraform.io/hashicorp/aws" ->ã€€ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã€‚ä»Šå›ã¯AWSã€‚
- version -> ä½¿ç”¨ã™ã‚‹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã€‚
- hashes -> ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®æ­£å½“æ€§ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®ãƒãƒƒã‚·ãƒ¥æƒ…å ±ã‚’å«ã‚€ãƒªã‚¹ãƒˆã€‚ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ãƒã‚¤ãƒŠãƒªãƒ•ã‚¡ã‚¤ãƒ«ã®æ•´åˆæ€§ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã€ä¸æ­£ãªå¤‰æ›´ã‚„æ”¹ã–ã‚“ãŒãªã„ã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚

ã“ã®ã‚ˆã†ãªæ„Ÿã˜ã§ã™ã€‚

ãŠã„ãŠã„ã€h1ã¨ã‹zhã£ã¦ä½•ã˜ã‚ƒã„ï¼ã¨æ€ã‚ã‚Œã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ãã‚‚ãã‚‚ã€Œ.terraform.lock.hclã€ã®å†…å®¹ã‚’è©³ã—ãæ›¸ãã ã‘ã§è¨˜äº‹ãŒæ›¸ã‘ã¦ã—ã¾ã†ã®ã§ã€ä»Šå›ã¯é›‘ãªèª¬æ˜ã§ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚æ©Ÿä¼šãŒã‚ã‚Œã°ã“ã®å†…å®¹ã«çµã£ã¦æ›¸ãã¾ã™(æ³£)

â†“ ä¸€å¿œã‚ã‹ã‚Šã‚„ã™ã‹ã£ãŸè¨˜äº‹ã‚„è³‡æ–™ã‚’ã‚ã’ã¦ãŠãã¾ã™ã€‚
https://rurukblog.com/post/terraform-lock-hcl/
https://speakerdeck.com/minamijoyo/how-to-update-terraform-dot-lock-dot-hcl-efficiently?slide=18

# å‚è€ƒè³‡æ–™ã¾ã¨ã‚
https://www.terraform.io/
https://www.lac.co.jp/lacwatch/service/20200903_002270.html
https://dev.classmethod.jp/articles/terraform_tfstate_management_tfc/
https://capsulecloud.io/terraform-variable
https://rurukblog.com/post/terraform-lock-hcl/
https://speakerdeck.com/minamijoyo/how-to-update-terraform-dot-lock-dot-hcl-efficiently?slide=18